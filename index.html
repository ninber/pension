<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Geopolitical Pension Simulator 2.4</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root { --nato:#1f4e79; --warsaw:#7a1f1f; --nato-light:#dceeff; --warsaw-light:#ffe3e3; }
    body { margin:0; font-family:system-ui,sans-serif; background:#f5f7fa; color:#222; }
    .container { max-width:1480px; margin:0 auto; padding:20px; }
    header { background:linear-gradient(135deg,var(--nato),var(--warsaw)); color:white; padding:30px; border-radius:16px; text-align:center; margin-bottom:25px; }
    .explanation { background:white; padding:20px; border-radius:12px; margin-bottom:25px; border-left:6px solid var(--nato); }
    .grid { display:grid; grid-template-columns:320px 1fr 1fr; gap:24px; }
    .card { background:white; border-radius:16px; box-shadow:0 8px 25px rgba(0,0,0,0.08); padding:24px; position:relative; }
    .nato-card { border-top:7px solid var(--nato); background:var(--nato-light); }
    .warsaw-card { border-top:7px solid var(--warsaw); background:var(--warsaw-light); }
    .watermark { position:absolute; top:48%; left:50%; transform:translate(-50%,-50%) rotate(-20deg); font-size:88px; font-weight:900; opacity:0.04; pointer-events:none; }
    label { display:block; margin:16px 0 6px; font-weight:600; }
    input[type=range] { width:100%; }
    .value { font-weight:bold; color:#1f4e79; }
    button { width:100%; padding:16px; background:var(--nato); color:white; border:none; border-radius:12px; font-size:17px; cursor:pointer; margin-top:15px; }
    .results { margin-top:22px; padding:18px; background:rgba(255,255,255,0.75); border-radius:12px; font-size:15.2px; line-height:1.6; }
    .comparative { grid-column:1/-1; }
    .heatmap-wrapper { position:relative; margin:15px 0 10px; padding-left:45px; }
    .y-labels { position:absolute; left:-45px; top:0; height:100%; display:flex; flex-direction:column; justify-content:space-around; font-size:12px; font-weight:600; color:#555; }
    .y-label { height:46px; display:flex; align-items:center; }
    .heatmap { display:grid; grid-template-columns:repeat(10,1fr); gap:4px; }
    .heat-cell { height:46px; display:flex; align-items:center; justify-content:center; font-weight:700; color:white; border-radius:6px; font-size:13.5px; }
    .x-labels { display:grid; grid-template-columns:repeat(10,1fr); gap:4px; margin-top:4px; }
    .x-label { text-align:center; font-size:12px; font-weight:600; color:#555; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Geopolitical Pension Simulator 2.4</h1>
      <p>Персональний розрахунок твоєї пенсії</p>
    </header>

    <div class="explanation">
      <strong>Як працює симулятор:</strong> Вводь свої реальні дані. Крива виживання починається від твого поточного віку і показує накопичувальну ймовірність дожити до кожного віку.
    </div>

    <div class="grid">
      <!-- Inputs -->
      <div class="card">
        <h2>Твої дані</h2>
        <label>Поточний вік <span class="value" id="v_start">28</span></label>
        <input type="range" min="20" max="50" value="28" id="startAge" oninput="document.getElementById('v_start').textContent=this.value">

        <label>Пенсійний вік <span class="value" id="v_ret">62</span></label>
        <input type="range" min="58" max="70" value="62" id="retAge" oninput="document.getElementById('v_ret').textContent=this.value">

        <label>Місячна зарплата зараз (грн) <span class="value" id="v_sal">28000</span></label>
        <input type="range" min="12000" max="120000" step="500" value="28000" id="salary" oninput="document.getElementById('v_sal').textContent=this.value">

        <label>Вже накопичено (грн) <span class="value" id="v_acc">45000</span></label>
        <input type="range" min="0" max="500000" step="5000" value="45000" id="existingCapital" oninput="document.getElementById('v_acc').textContent=this.value">

        <label>Вже стаж (років) <span class="value" id="v_sta">7</span></label>
        <input type="range" min="0" max="35" value="7" id="existingStazh" oninput="document.getElementById('v_sta').textContent=this.value">

        <label>Ріст зарплати (%) <span class="value" id="v_grow">4.8</span></label>
        <input type="range" min="0" max="12" step="0.2" value="4.8" id="salaryGrowth" oninput="document.getElementById('v_grow').textContent=this.value">

        <label>Інфляція (%) <span class="value" id="v_inf">6</span></label>
        <input type="range" min="3" max="15" step="0.2" value="6" id="inflation" oninput="document.getElementById('v_inf').textContent=this.value">

        <label>Внесок (%) <span class="value" id="v_con">22</span></label>
        <input type="range" min="18" max="30" step="0.5" value="22" id="contribution" oninput="document.getElementById('v_con').textContent=this.value">

        <label>Дохідність інвестицій (%) <span class="value" id="v_retu">8.2</span></label>
        <input type="range" min="4" max="13" step="0.2" value="8.2" id="return" oninput="document.getElementById('v_retu').textContent=this.value">

        <label>Очікувана тривалість життя (років) <span class="value" id="v_life">83</span></label>
        <input type="range" min="72" max="98" value="83" id="lifeExpectancy" oninput="document.getElementById('v_life').textContent=this.value">

        <button onclick="runSimulation()">Прорахувати</button>
      </div>

      <!-- NATO -->
      <div class="card nato-card">
        <div class="watermark">NATO</div>
        <h2 style="color:var(--nato)">Приватна накопичувальна модель</h2>
        <canvas id="natoChart"></canvas>
        <div class="results" id="natoResults"></div>
      </div>

      <!-- Warsaw -->
      <div class="card warsaw-card">
        <div class="watermark">WARSAW</div>
        <h2 style="color:var(--warsaw)">Солідарна державна модель</h2>
        <canvas id="warsawChart"></canvas>
        <div class="results" id="warsawResults"></div>
      </div>
    </div>

    <div class="comparative card">
      <h2>Порівняльна аналітика</h2>
      <canvas id="comparisonChart" height="120"></canvas>

      <h3 style="margin-top:35px">Monte Carlo — розподіл фінального капіталу (1000 симуляцій)</h3>
      <canvas id="monteCarloChart" height="120"></canvas>

      <h3 style="margin-top:35px">Крива виживання (накопичувальна, від твого поточного віку)</h3>
      <canvas id="survivalChart" height="120"></canvas>

      <h3 style="margin-top:35px">Heatmap: хто виграє залежно від дохідності інвестицій та тривалості життя</h3>
      <div class="heatmap-wrapper">
        <div class="y-labels" id="yLabels"></div>
        <div class="heatmap" id="heatmap"></div>
        <div class="x-labels" id="xLabels"></div>
      </div>
      <div style="text-align:center; margin-top:12px; font-size:14px; color:#555;">
        Синій = приватна (NATO) виграє • Червоний = солідарна (Warsaw) виграє • Сірий = рівно
      </div>
    </div>
  </div>

  <script>
    let charts = {};

    function calculatePrivate(inputs) {
      let capital = inputs.existingCapital;
      let salary = inputs.salary * 12;
      const yearsToRet = inputs.retAge - inputs.startAge;
      const history = [capital];
      for (let y = 0; y < yearsToRet; y++) {
        capital = capital * (1 + inputs.return/100) + salary * (inputs.contribution/100);
        salary *= (1 + inputs.salaryGrowth/100);
        history.push(Math.round(capital));
      }
      return { finalCapital: Math.round(capital), history };
    }

    function calculateWarsaw(inputs) {
      const totalStazh = inputs.existingStazh + (inputs.retAge - inputs.startAge);
      const Ks = Math.min(totalStazh * 0.01, 0.45);
      const Zs = inputs.salary * 12 * Math.pow(1 + inputs.salaryGrowth/100 * 0.7, inputs.retAge - inputs.startAge);
      const initialPension = Zs * Ks;
      const yearsAfter = inputs.lifeExpectancy - inputs.retAge;
      let pensions = [], total = 0, current = initialPension;
      for (let i = 0; i < yearsAfter; i++) {
        pensions.push(Math.round(current));
        total += current;
        current *= (1 + inputs.inflation/100);
      }
      return { initialPension: Math.round(initialPension), pensions, totalReceived: Math.round(total) };
    }

    function runSimulation() {
      const inputs = {
        startAge: +document.getElementById('startAge').value,
        retAge: +document.getElementById('retAge').value,
        salary: +document.getElementById('salary').value,
        existingCapital: +document.getElementById('existingCapital').value,
        existingStazh: +document.getElementById('existingStazh').value,
        salaryGrowth: +document.getElementById('salaryGrowth').value,
        inflation: +document.getElementById('inflation').value,
        contribution: +document.getElementById('contribution').value,
        return: +document.getElementById('return').value,
        lifeExpectancy: +document.getElementById('lifeExpectancy').value
      };

      const priv = calculatePrivate(inputs);
      const war = calculateWarsaw(inputs);

      // NATO chart & results
      document.getElementById('natoResults').innerHTML = `Фінальний капітал: <strong>${priv.finalCapital.toLocaleString('uk-UA')} грн</strong>`;
      if (charts.nato) charts.nato.destroy();
      const natoYears = Array.from({length: priv.history.length}, (_,i) => inputs.startAge + i);
      charts.nato = new Chart(document.getElementById('natoChart'), { type: 'line', data: { labels: natoYears, datasets: [{ label: 'Капітал', data: priv.history, borderColor: '#1f4e79', tension: 0.4 }] } });

      // Warsaw chart & results
      document.getElementById('warsawResults').innerHTML = `Початкова пенсія: <strong>${war.initialPension.toLocaleString('uk-UA')} грн/міс</strong><br>Загалом: <strong>${war.totalReceived.toLocaleString('uk-UA')} грн</strong>`;
      if (charts.warsaw) charts.warsaw.destroy();
      const warYears = Array.from({length: war.pensions.length}, (_,i) => inputs.retAge + i);
      charts.warsaw = new Chart(document.getElementById('warsawChart'), { type: 'line', data: { labels: warYears, datasets: [{ label: 'Пенсія', data: war.pensions, borderColor: '#7a1f1f', tension: 0.3 }] } });

      // Comparison & Monte Carlo (спрощено, як раніше)

      // Survival curve — накопичувальна від поточного віку
      if (charts.survival) charts.survival.destroy();
      const ages = Array.from({length: inputs.lifeExpectancy - inputs.startAge + 1}, (_,i) => inputs.startAge + i);
      let survivalData = [100];
      let curr = 100;
      for (let i = 1; i < ages.length; i++) {
        const age = ages[i];
        const mortality = 0.008 + 0.00038 * Math.pow(1.102, age - inputs.startAge);
        curr *= (1 - mortality);
        survivalData.push(Math.max(0, Math.round(curr)));
      }
      charts.survival = new Chart(document.getElementById('survivalChart'), {
        type: 'line',
        data: { labels: ages, datasets: [{ label: 'Ймовірність дожити (%)', data: survivalData, borderColor: '#2c3e50', tension: 0.35 }] }
      });

      // Heatmap + labels
      const returns = [4,5,6,7,8,9,10,11,12,13];
      const lives = [74,76,78,80,82,84,86,88,90,94];

      // Y labels
      const yLabels = document.getElementById('yLabels');
      yLabels.innerHTML = lives.map(l => `<div class="y-label">${l}</div>`).join('');

      // X labels
      const xLabels = document.getElementById('xLabels');
      xLabels.innerHTML = returns.map(r => `<div class="x-label">${r}%</div>`).join('');

      // Heatmap cells
      const hm = document.getElementById('heatmap');
      hm.innerHTML = '';
      returns.forEach(r => {
        lives.forEach(l => {
          const test = {...inputs, return: r, lifeExpectancy: l};
          const p = calculatePrivate(test).finalCapital * 0.6 + test.existingCapital;
          const w = calculateWarsaw(test).totalReceived;
          const ratio = p / (w || 1);
          let color = ratio > 1.4 ? '#1f4e79' : ratio > 1.1 ? '#4a8fd4' : ratio > 0.9 ? '#999' : ratio > 0.65 ? '#c95a5a' : '#7a1f1f';
          let txt = ratio > 1.25 ? 'N' : ratio < 0.8 ? 'W' : '≈';
          const cell = document.createElement('div');
          cell.className = 'heat-cell';
          cell.style.backgroundColor = color;
          cell.textContent = txt;
          hm.appendChild(cell);
        });
      });
    }

    window.onload = runSimulation;
  </script>
</body>
</html>
