<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Geopolitical Pension Simulator 2.2</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --nato: #1f4e79;
      --warsaw: #7a1f1f;
      --nato-light: #dceeff;
      --warsaw-light: #ffe3e3;
    }
    body { margin:0; font-family:system-ui,sans-serif; background:#f5f7fa; color:#222; }
    .container { max-width:1480px; margin:0 auto; padding:20px; }
    header { background:linear-gradient(135deg,var(--nato),var(--warsaw)); color:white; padding:30px; border-radius:16px; text-align:center; margin-bottom:30px; }
    .explanation {
      background:#fff; padding:18px; border-radius:12px; margin-bottom:24px; border-left:5px solid #1f4e79;
      font-size:15.5px; line-height:1.55;
    }
    .grid { display:grid; grid-template-columns:300px 1fr 1fr; gap:24px; }
    .card {
      background:white; border-radius:16px; box-shadow:0 6px 20px rgba(0,0,0,0.07); padding:24px; position:relative;
    }
    .nato-card { border-top:6px solid var(--nato); background:var(--nato-light); }
    .warsaw-card { border-top:6px solid var(--warsaw); background:var(--warsaw-light); }
    .watermark {
      position:absolute; top:50%; left:50%; transform:translate(-50%,-50%) rotate(-18deg);
      font-size:92px; font-weight:900; opacity:0.035; pointer-events:none; color:#000;
    }
    label { display:block; margin:14px 0 6px; font-weight:600; }
    input[type=range] { width:100%; }
    .value { font-weight:bold; color:#1f4e79; }
    button {
      width:100%; padding:15px; background:var(--nato); color:white; border:none;
      border-radius:12px; font-size:17px; cursor:pointer; margin-top:12px;
    }
    .results { margin-top:20px; padding:16px; background:rgba(255,255,255,0.7); border-radius:12px; font-size:15px; }
    .comparative { grid-column:1/-1; }
    .heatmap-container { position:relative; margin-top:12px; }
    .heatmap { display:grid; grid-template-columns:repeat(10,1fr); gap:4px; }
    .heat-cell { height:44px; display:flex; align-items:center; justify-content:center; font-weight:700; color:white; border-radius:6px; font-size:13px; }
    .axis-label { text-align:center; font-weight:600; margin:8px 0 4px; }
    .legend { display:flex; gap:20px; justify-content:center; margin-top:12px; font-size:14px; }
    .legend-item { display:flex; align-items:center; gap:8px; }
    .legend-color { width:18px; height:18px; border-radius:4px; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Geopolitical Pension Simulator 2.2</h1>
      <p>Персональний прорахунок пенсії: приватна (NATO) vs солідарна (Warsaw) система</p>
    </header>

    <div class="explanation">
      <strong>Як працює симулятор:</strong> Ви вводите свої поточні дані (вік, зарплата тощо). 
      Розрахунок ведеться від сьогоднішнього дня до очікуваної тривалості життя. 
      Всі суми показані в сьогоднішніх гривнях (з урахуванням інфляції). 
      Це персональний сценарій «для себе».
    </div>

    <div class="grid">
      <!-- Inputs -->
      <div class="card">
        <h2>Ваші дані</h2>
        <label>Поточний вік <span class="value" id="v1">28</span></label>
        <input type="range" min="20" max="45" value="28" id="startAge" oninput="document.getElementById('v1').textContent=this.value">

        <label>Пенсійний вік <span class="value" id="v2">62</span></label>
        <input type="range" min="58" max="70" value="62" id="retAge" oninput="document.getElementById('v2').textContent=this.value">

        <label>Місячна зарплата зараз (грн) <span class="value" id="v3">28000</span></label>
        <input type="range" min="12000" max="100000" step="500" value="28000" id="salary" oninput="document.getElementById('v3').textContent=this.value">

        <label>Річний ріст зарплати (%) <span class="value" id="v4">4.5</span></label>
        <input type="range" min="0" max="12" step="0.2" value="4.5" id="salaryGrowth" oninput="document.getElementById('v4').textContent=this.value">

        <label>Очікувана інфляція (%) <span class="value" id="v5">6</span></label>
        <input type="range" min="3" max="15" step="0.2" value="6" id="inflation" oninput="document.getElementById('v5').textContent=this.value">

        <label>Внесок (ЄСВ + накопичувальна, %) <span class="value" id="v6">22</span></label>
        <input type="range" min="18" max="30" step="0.5" value="22" id="contribution" oninput="document.getElementById('v6').textContent=this.value">

        <label>Очікувана дохідність інвестицій (%) <span class="value" id="v7">8</span></label>
        <input type="range" min="4" max="13" step="0.2" value="8" id="return" oninput="document.getElementById('v7').textContent=this.value">

        <label>Очікувана тривалість життя (років) <span class="value" id="v8">83</span></label>
        <input type="range" min="72" max="98" value="83" id="lifeExpectancy" oninput="document.getElementById('v8').textContent=this.value">

        <button onclick="runSimulation()">Прорахувати мій сценарій</button>
      </div>

      <!-- NATO -->
      <div class="card nato-card">
        <div class="watermark">NATO</div>
        <h2 style="color:var(--nato)">Приватна накопичувальна модель</h2>
        <canvas id="natoChart"></canvas>
        <div class="results" id="natoResults"></div>
      </div>

      <!-- Warsaw -->
      <div class="card warsaw-card">
        <div class="watermark">WARSAW</div>
        <h2 style="color:var(--warsaw)">Солідарна державна модель</h2>
        <canvas id="warsawChart"></canvas>
        <div class="results" id="warsawResults"></div>
      </div>
    </div>

    <div class="comparative card">
      <h2>Порівняльна аналітика</h2>
      <canvas id="comparisonChart" height="110"></canvas>

      <h3 style="margin-top:35px">Monte Carlo — розподіл результатів (1000 симуляцій)</h3>
      <canvas id="monteCarloChart" height="110"></canvas>

      <h3 style="margin-top:35px">Крива виживання (реалістична модель)</h3>
      <canvas id="survivalChart" height="110"></canvas>

      <h3 style="margin-top:35px">Heatmap: хто виграє при різних умовах</h3>
      <div class="heatmap-container">
        <div style="text-align:center; font-weight:600; margin-bottom:6px;">Дохідність інвестицій (%)</div>
        <div class="heatmap" id="heatmap"></div>
        <div class="axis-label">Очікувана тривалість життя (років)</div>
      </div>
      <div class="legend">
        <div class="legend-item"><div class="legend-color" style="background:#1f4e79"></div> NATO сильно виграє</div>
        <div class="legend-item"><div class="legend-color" style="background:#4a8fd4"></div> NATO виграє</div>
        <div class="legend-item"><div class="legend-color" style="background:#aaa"></div> Приблизно рівно</div>
        <div class="legend-item"><div class="legend-color" style="background:#c95a5a"></div> Warsaw виграє</div>
        <div class="legend-item"><div class="legend-color" style="background:#7a1f1f"></div> Warsaw сильно виграє</div>
      </div>
    </div>
  </div>

  <script>
    let charts = {};

    function calculatePrivate(inputs) {
      let capital = 0;
      let salary = inputs.salary * 12;
      const yearsToRet = inputs.retAge - inputs.startAge;
      const capitalHistory = [0];

      for (let y = 0; y < yearsToRet; y++) {
        capital = capital * (1 + inputs.return/100) + salary * (inputs.contribution/100);
        salary *= (1 + inputs.salaryGrowth/100);
        capitalHistory.push(Math.round(capital));
      }
      return { finalCapital: Math.round(capital), history: capitalHistory };
    }

    function calculateWarsaw(inputs) {
      const yearsService = inputs.retAge - inputs.startAge;
      const Ks = Math.min(yearsService * 0.01, 0.45);
      const Zs = inputs.salary * 12 * Math.pow(1 + inputs.salaryGrowth/100 * 0.75, yearsService); // консервативно
      const initialPensionMonthly = Zs * Ks * 1.0;

      const yearsAfter = inputs.lifeExpectancy - inputs.retAge;
      let pensions = [];
      let current = initialPensionMonthly;
      let total = 0;
      for (let i = 0; i < yearsAfter; i++) {
        pensions.push(Math.round(current));
        total += current;
        current *= (1 + inputs.inflation/100);
      }
      return { initialPension: Math.round(initialPensionMonthly), pensions, totalReceived: Math.round(total) };
    }

    function runSimulation() {
      const inputs = {
        startAge: +document.getElementById('startAge').value,
        retAge: +document.getElementById('retAge').value,
        salary: +document.getElementById('salary').value,
        salaryGrowth: +document.getElementById('salaryGrowth').value,
        inflation: +document.getElementById('inflation').value,
        contribution: +document.getElementById('contribution').value,
        return: +document.getElementById('return').value,
        lifeExpectancy: +document.getElementById('lifeExpectancy').value
      };

      const priv = calculatePrivate(inputs);
      const war = calculateWarsaw(inputs);

      // NATO Results + Chart
      document.getElementById('natoResults').innerHTML = `
        Фінальний капітал на пенсії: <strong>${priv.finalCapital.toLocaleString('uk-UA')} грн</strong><br>
        Орієнтовна щорічна виплата: <strong>${Math.round(priv.finalCapital * 0.052).toLocaleString('uk-UA')} грн</strong>
      `;
      if (charts.nato) charts.nato.destroy();
      const natoYears = Array.from({length: priv.history.length}, (_,i) => inputs.startAge + i);
      charts.nato = new Chart(document.getElementById('natoChart'), {
        type: 'line',
        data: { labels: natoYears, datasets: [{ label: 'Накопичений капітал (грн)', data: priv.history, borderColor: '#1f4e79', tension: 0.4 }] },
        options: { plugins: { legend: { display: true } } }
      });

      // Warsaw Results + Chart
      document.getElementById('warsawResults').innerHTML = `
        Початкова пенсія: <strong>${war.initialPension.toLocaleString('uk-UA')} грн/міс</strong><br>
        Загалом за життя (з індексацією): <strong>${war.totalReceived.toLocaleString('uk-UA')} грн</strong>
      `;
      const warYears = Array.from({length: war.pensions.length}, (_,i) => inputs.retAge + i);
      if (charts.warsaw) charts.warsaw.destroy();
      charts.warsaw = new Chart(document.getElementById('warsawChart'), {
        type: 'line',
        data: { labels: warYears, datasets: [{ label: 'Щорічна пенсія (грн)', data: war.pensions, borderColor: '#7a1f1f', tension: 0.3 }] }
      });

      // Heatmap
      const container = document.getElementById('heatmap');
      container.innerHTML = '';
      const returns = [4,5,6,7,8,9,10,11,12,13];
      const lives = [74,76,78,80,82,84,86,88,90,92];
      returns.forEach(r => {
        lives.forEach(l => {
          const test = {...inputs, return:r, lifeExpectancy:l};
          const p = calculatePrivate(test).finalCapital;
          const w = calculateWarsaw(test).totalReceived;
          const ratio = p / (w || 1);
          let color = ratio > 1.5 ? '#1f4e79' : ratio > 1.15 ? '#4a8fd4' : ratio > 0.85 ? '#aaa' : ratio > 0.6 ? '#c95a5a' : '#7a1f1f';
          let txt = ratio > 1.3 ? 'N' : ratio < 0.75 ? 'W' : '≈';
          const cell = document.createElement('div');
          cell.className = 'heat-cell';
          cell.style.backgroundColor = color;
          cell.textContent = txt;
          container.appendChild(cell);
        });
      });

      // Survival curve (реалістична)
      if (charts.survival) charts.survival.destroy();
      const ages = Array.from({length: 35}, (_,i) => inputs.retAge + i);
      const survival = ages.map(age => {
        const base = Math.exp(-0.0004 * Math.pow(1.085, age - 40));
        return Math.max(3, Math.round(100 * base));
      });
      charts.survival = new Chart(document.getElementById('survivalChart'), {
        type: 'line',
        data: { labels: ages, datasets: [{ label: 'Ймовірність дожити до віку (%)', data: survival, borderColor: '#2c3e50', tension: 0.35 }] }
      });
    }

    window.onload = runSimulation;
  </script>
</body>
</html>
